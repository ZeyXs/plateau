name: Docker Build and Push

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Login to GHCR.io
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.TOKEN }}
      
    - name: Build and push frontend image
      if: ${{ github.event_name == 'push' && contains(github.event.head_commit.modified, 'client/') }}
      run: |
        cd client/
        docker build -t plateau-frontend:latest .
        docker tag plateau-frontend:latest ghcr.io/zeyxs/plateau-frontend:latest
        docker push ghcr.io/zeyxs/plateau-frontend:latest

    - name: Build and push backend image
      if: ${{ github.event_name == 'push' && contains(github.event.head_commit.modified, 'server/') }}
      run: |
        cd server/
        docker build -t plateau-backend:latest .
        docker tag plateau-backend:latest ghcr.io/zeyxs/plateau-backend:latest
        docker push ghcr.io/zeyxs/plateau-backend:latest